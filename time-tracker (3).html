<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enkel Timetracker</title>
  <style>
    :root {
      --bg-dark: #121212;
      --bg-card: #1e1e1e;
      --bg-modal: #242424;
      --text-primary: #ffffff;
      --text-secondary: #b0b0b0;
      --accent-primary: #9d4edd;
      --accent-secondary: #7b2cbf;
      --accent-gradient: linear-gradient(135deg, #9d4edd, #7b2cbf);
      --inactive: #4f4f4f;
      --active: #9d4edd;
      --border-inactive: #383838;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      --transition: all 0.3s ease;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--bg-dark);
      color: var(--text-primary);
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 2.5rem;
      letter-spacing: 1px;
    }
    
    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: flex-start;
    }
    
    .customer-box {
      width: 250px;
      height: 150px;
      background-color: var(--bg-card);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 15px;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid var(--border-inactive);
    }
    
    .customer-box:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(157, 78, 221, 0.2);
      border-color: var(--accent-primary);
    }
    
    .customer-box.active {
      box-shadow: 0 8px 25px rgba(157, 78, 221, 0.4);
      border: 1px solid var(--accent-primary);
      background: linear-gradient(to bottom, var(--bg-card), rgba(123, 44, 191, 0.1));
    }
    
    .customer-name {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
      color: var(--text-primary);
    }
    
    .available-hours {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }
    
    .timer {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
      color: var(--accent-primary);
    }
    
    .status {
      position: absolute;
      bottom: 15px;
      left: 15px;
      font-size: 14px;
      color: var(--inactive);
    }
    
    .active .status {
      color: var(--active);
      font-weight: bold;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
    }
    
    .modal-content {
      background-color: var(--bg-modal);
      margin: 15% auto;
      padding: 25px;
      border-radius: 15px;
      width: 50%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
      border: 1px solid var(--accent-secondary);
    }
    
    .close {
      color: var(--text-secondary);
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .close:hover {
      color: var(--accent-primary);
    }
    
    textarea {
      width: 100%;
      height: 100px;
      padding: 12px;
      margin: 10px 0;
      border-radius: 8px;
      background-color: var(--bg-dark);
      border: 1px solid var(--border-inactive);
      resize: none;
      color: var(--text-primary);
      font-family: inherit;
      transition: var(--transition);
    }
    
    textarea:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 8px rgba(157, 78, 221, 0.3);
    }
    
    .submit-btn {
      background: var(--accent-gradient);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: var(--transition);
    }
    
    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(157, 78, 221, 0.4);
    }
    
    .add-customer {
      width: 250px;
      height: 150px;
      background: linear-gradient(to bottom, var(--bg-card), rgba(123, 44, 191, 0.05));
      border: 1px dashed var(--border-inactive);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      order: -1; /* Makes this appear first */
      transition: var(--transition);
    }
    
    .add-customer:hover {
      border-color: var(--accent-primary);
      box-shadow: 0 5px 15px rgba(157, 78, 221, 0.2);
      transform: translateY(-5px);
    }
    
    .add-customer.active {
      border: 1px solid var(--accent-primary);
      background: linear-gradient(to bottom, var(--bg-card), rgba(123, 44, 191, 0.2));
    }
    
    .add-customer-icon {
      font-size: 40px;
      color: var(--inactive);
      transition: var(--transition);
    }
    
    .add-customer:hover .add-customer-icon {
      color: var(--accent-primary);
    }
    
    .add-customer.active .add-customer-icon {
      color: var(--accent-primary);
    }
    
    .add-customer-timer {
      font-size: 24px;
      font-weight: bold;
      margin-top: 10px;
      color: var(--accent-primary);
    }
    
    .new-customer-modal .modal-content {
      width: 40%;
      max-height: 80vh;
      overflow-y: auto;
      margin: 10% auto;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: var(--text-primary);
    }
    
    .form-group input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      background-color: var(--bg-dark);
      border: 1px solid var(--border-inactive);
      color: var(--text-primary);
      font-family: inherit;
      transition: var(--transition);
    }
    
    .form-group input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 8px rgba(157, 78, 221, 0.3);
    }
    
    /* Styling for modal titles */
    .modal-content h2 {
      color: var(--text-primary);
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 1.6rem;
      border-bottom: 1px solid var(--border-inactive);
      padding-bottom: 10px;
    }
    
    /* Styling for customer info in modal */
    #modal-customer-name, #new-customer-time-spent {
      color: var(--accent-primary);
      font-weight: 500;
      font-size: 1.1rem;
    }
    
    #modal-time-spent {
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Timetracker</h1>
  </div>
  
  <div class="container" id="customer-container">
    <!-- Add customer button always comes first -->
    <div class="add-customer" id="add-customer-box" onclick="startNewCustomerTimer()">
      <div class="add-customer-icon">+</div>
      <div class="add-customer-timer" id="new-customer-timer">00:00:00</div>
    </div>
    
    <!-- Customer boxes will be added here, sorted alphabetically -->
  </div>
  
  <!-- Modal for comments -->
  <div id="commentModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('commentModal')">&times;</span>
      <h2>Legg til kommentar</h2>
      <p id="modal-customer-name">Kunde AS</p>
      <p id="modal-time-spent">Tid brukt: 00:00:00</p>
      <textarea id="comment-text" placeholder="Skriv en kommentar om arbeidet..."></textarea>
      <button class="submit-btn" onclick="submitTime()">Lagre og avslutt</button>
    </div>
  </div>
  
  <!-- Modal for new customer -->
  <div id="newCustomerModal" class="modal new-customer-modal">
    <div class="modal-content">
      <span class="close" onclick="cancelNewCustomer()">&times;</span>
      <h2>Legg til ny kunde</h2>
      <p id="new-customer-time-spent">Tid brukt: 00:00:00</p>
      
      <div class="form-group">
        <label for="new-customer-name">Kundenavn:</label>
        <input type="text" id="new-customer-name" placeholder="Skriv inn kundenavn">
      </div>
      
      <div class="form-group">
        <label for="new-customer-hours">Timer tilgjengelig:</label>
        <input type="number" id="new-customer-hours" placeholder="Antall timer">
      </div>
      
      <div class="form-group">
        <label for="new-customer-comment">Kommentar:</label>
        <textarea id="new-customer-comment" placeholder="Skriv en kommentar om arbeidet..."></textarea>
      </div>
      
      <button class="submit-btn" onclick="createNewCustomer()">Lagre kunde og tid</button>
    </div>
  </div>
  
  <script>
    // Store active timers and their data
    const timers = {};
    let activeBox = null;
    let customers = [];
    let newCustomerTimer = null;
    
    // Load customer data from Google Sheets (mock data for now)
    function loadCustomers() {
      // In a real implementation, this would fetch data from Google Sheets
      // For now, we'll use mock data
      const mockCustomerData = [
        { name: "Kunde 1 AS", availableHours: 40 },
        { name: "Kunde 3 AS", availableHours: 25 },
        { name: "Kunde 2 AS", availableHours: 60 },
        { name: "Kunde 4 AS", availableHours: 15 }
      ];
      
      // Sort customers alphabetically
      customers = mockCustomerData.sort((a, b) => a.name.localeCompare(b.name));
      
      // Render the customer boxes
      renderCustomers();
    }
    
    function renderCustomers() {
      const container = document.getElementById('customer-container');
      
      // Clear existing customer boxes, but keep the "add customer" button
      const addCustomerButton = document.querySelector('.add-customer');
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }
      container.appendChild(addCustomerButton);
      
      // Add all customers in alphabetical order
      customers.forEach((customer, index) => {
        const customerBox = document.createElement('div');
        customerBox.className = 'customer-box';
        customerBox.setAttribute('data-id', index + 1);
        customerBox.onclick = function() { toggleTimer(this); };
        
        customerBox.innerHTML = `
          <div class="customer-name">${customer.name}</div>
          <div class="available-hours">Timer tilgjengelig: ${customer.availableHours.toFixed(1)}</div>
          <div class="timer">00:00:00</div>
          <div class="status">Inaktiv</div>
        `;
        
        container.appendChild(customerBox);
      });
    }
    
    function toggleTimer(box) {
      const customerId = box.getAttribute('data-id');
      const timerDisplay = box.querySelector('.timer');
      const statusDisplay = box.querySelector('.status');
      const customerName = box.querySelector('.customer-name').textContent;
      
      // If this box is already active, stop the timer and show comment modal
      if (box.classList.contains('active')) {
        clearInterval(timers[customerId].interval);
        box.classList.remove('active');
        statusDisplay.textContent = 'Inaktiv';
        
        // Calculate time spent
        const endTime = new Date();
        const timeSpent = endTime - timers[customerId].startTime;
        const timeSpentFormatted = formatTime(timeSpent);
        
        // Show comment modal
        const modal = document.getElementById('commentModal');
        document.getElementById('modal-customer-name').textContent = customerName;
        document.getElementById('modal-time-spent').textContent = 'Tid brukt: ' + timeSpentFormatted;
        modal.style.display = 'block';
        
        // Save data for submission
        timers[customerId].endTime = endTime;
        timers[customerId].timeSpentFormatted = timeSpentFormatted;
        timers[customerId].timeSpentMs = timeSpent;
        activeBox = box;
      } else {
        // If another box is active (including new customer), deactivate it first
        if (activeBox) {
          toggleTimer(activeBox);
        } else if (document.getElementById('add-customer-box').classList.contains('active')) {
          stopNewCustomerTimer();
        }
        
        // Start a new timer
        box.classList.add('active');
        statusDisplay.textContent = 'Aktiv';
        
        const startTime = new Date();
        timers[customerId] = {
          startTime: startTime,
          customerName: customerName,
          interval: setInterval(() => {
            const currentTime = new Date();
            const elapsedTime = currentTime - startTime;
            timerDisplay.textContent = formatTime(elapsedTime);
          }, 1000)
        };
        
        activeBox = box;
      }
    }
    
    function startNewCustomerTimer() {
      // If there's an active timer for an existing customer, stop it
      if (activeBox) {
        toggleTimer(activeBox);
        return;
      }
      
      // If the new customer timer is already active, stop it
      const addCustomerBox = document.getElementById('add-customer-box');
      if (addCustomerBox.classList.contains('active')) {
        stopNewCustomerTimer();
        return;
      }
      
      // Start the new customer timer
      addCustomerBox.classList.add('active');
      const timerDisplay = document.getElementById('new-customer-timer');
      
      const startTime = new Date();
      newCustomerTimer = {
        startTime: startTime,
        interval: setInterval(() => {
          const currentTime = new Date();
          const elapsedTime = currentTime - startTime;
          timerDisplay.textContent = formatTime(elapsedTime);
        }, 1000)
      };
    }
    
    function stopNewCustomerTimer() {
      if (!newCustomerTimer) return;
      
      clearInterval(newCustomerTimer.interval);
      const addCustomerBox = document.getElementById('add-customer-box');
      addCustomerBox.classList.remove('active');
      
      // Calculate time spent
      const endTime = new Date();
      const timeSpent = endTime - newCustomerTimer.startTime;
      const timeSpentFormatted = formatTime(timeSpent);
      
      // Show the new customer modal
      const modal = document.getElementById('newCustomerModal');
      document.getElementById('new-customer-time-spent').textContent = 'Tid brukt: ' + timeSpentFormatted;
      modal.style.display = 'block';
      
      // Save time data for later use
      newCustomerTimer.endTime = endTime;
      newCustomerTimer.timeSpentFormatted = timeSpentFormatted;
      newCustomerTimer.timeSpentMs = timeSpent;
    }
    
    function formatTime(ms) {
      let seconds = Math.floor(ms / 1000);
      let minutes = Math.floor(seconds / 60);
      let hours = Math.floor(minutes / 60);
      
      seconds = seconds % 60;
      minutes = minutes % 60;
      
      return `${padZero(hours)}:${padZero(minutes)}:${padZero(seconds)}`;
    }
    
    function padZero(num) {
      return num.toString().padStart(2, '0');
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
      if (modalId === 'commentModal') {
        document.getElementById('comment-text').value = '';
      }
    }
    
    function calculateHoursFromMs(ms) {
      // Convert milliseconds to decimal hours
      const rawHours = ms / (1000 * 60 * 60);
      
      // For logging in Google Sheets, round to quarter hours (0.25)
      // e.g., 15 min = 0.25, 30 min = 0.5, 45 min = 0.75
      return Math.round(rawHours * 4) / 4;
    }
    
    function submitTime() {
      const customerId = activeBox.getAttribute('data-id');
      const comment = document.getElementById('comment-text').value;
      
      // Get current date
      const now = new Date();
      const dateStr = `${now.getFullYear()}-${padZero(now.getMonth() + 1)}-${padZero(now.getDate())}`;
      
      // Calculate decimal hours (rounded to quarter hours)
      const decimalHours = calculateHoursFromMs(timers[customerId].timeSpentMs);
      
      // Get customer's total sold hours and remaining hours
      let soldHours = 0;
      let remainingHours = 0;
      
      const customerIndex = parseInt(customerId) - 1;
      if (customerIndex >= 0 && customerIndex < customers.length) {
        // In a real implementation, get this from Google Sheets
        soldHours = customers[customerIndex].availableHours + decimalHours; // Original hours before this session
        remainingHours = customers[customerIndex].availableHours - decimalHours; // Remaining after this session
        
        // Update the available hours
        customers[customerIndex].availableHours = remainingHours;
        if (customers[customerIndex].availableHours < 0) {
          customers[customerIndex].availableHours = 0;
        }
      }
      
      // Prepare the data to be sent to Google Sheets
      const data = {
        customerName: timers[customerId].customerName,
        timeSpent: decimalHours,
        soldHours: soldHours,
        remainingHours: remainingHours,
        comment: comment,
        date: dateStr
      };
      
      // This is where you would send the data to Google Sheets
      // In a real implementation, you would need to set up Google Sheets API
      console.log('Data to send to Google Sheets:', data);
      
      // Example of how the data would be structured for Google Sheets
      console.log('Google Sheets row: [' +
        data.date + ', ' +
        data.customerName + ', ' +
        data.timeSpent + ', ' + 
        data.soldHours + ', ' +
        data.remainingHours + ', ' +
        '"' + data.comment + '"' +
      ']');
      
      // Reset the timer display
      activeBox.querySelector('.timer').textContent = '00:00:00';
      
      // Close the modal
      closeModal('commentModal');
      
      // Clear the active box reference
      activeBox = null;
      
      // Re-render the customers to show updated available hours
      renderCustomers();
      
      // Show confirmation (in a real app, you'd show a proper notification)
      alert('Timer lagret for ' + data.customerName + '!');
    }
    
    function createNewCustomer() {
      const customerName = document.getElementById('new-customer-name').value.trim();
      const availableHours = parseFloat(document.getElementById('new-customer-hours').value) || 0;
      const comment = document.getElementById('new-customer-comment').value.trim();
      
      if (!customerName) {
        alert('Vennligst skriv inn et kundenavn.');
        return;
      }
      
      // Get current date
      const now = new Date();
      const dateStr = `${now.getFullYear()}-${padZero(now.getMonth() + 1)}-${padZero(now.getDate())}`;
      
      // Calculate decimal hours (rounded to quarter hours)
      const decimalHours = calculateHoursFromMs(newCustomerTimer.timeSpentMs);
      
      // For new customers, total sold hours is what user entered, remaining is after this session
      const soldHours = availableHours + decimalHours; // Original sold hours
      const remainingHours = availableHours; // What will be stored as available (already calculated earlier)
      
      // Prepare the data to be sent to Google Sheets
      const data = {
        customerName: customerName,
        timeSpent: decimalHours,
        soldHours: soldHours,
        remainingHours: remainingHours,
        comment: comment,
        date: dateStr
      };
      
      // This is where you would send the data to Google Sheets
      // In a real implementation, you would need to set up Google Sheets API
      console.log('Data to send to Google Sheets:', data);
      
      // Example of how the data would be structured for Google Sheets
      console.log('Google Sheets row: [' +
        data.date + ', ' +
        data.customerName + ', ' +
        data.timeSpent + ', ' + 
        data.soldHours + ', ' +
        data.remainingHours + ', ' +
        '"' + data.comment + '"' +
      ']');
      
      // Add the new customer with hours already adjusted for time spent
      const actualAvailableHours = Math.max(0, availableHours);
      
      // Add the new customer to the list
      customers.push({
        name: customerName,
        availableHours: actualAvailableHours
      });
      
      // Sort and re-render
      customers.sort((a, b) => a.name.localeCompare(b.name));
      renderCustomers();
      
      // Reset the new customer timer
      document.getElementById('new-customer-timer').textContent = '00:00:00';
      
      // Close the modal and reset fields
      closeModal('newCustomerModal');
      document.getElementById('new-customer-name').value = '';
      document.getElementById('new-customer-hours').value = '';
      document.getElementById('new-customer-comment').value = '';
      
      // Clear the timer data
      newCustomerTimer = null;
      
      // Show confirmation
      alert('Ny kunde opprettet: ' + customerName);
    }
    
    function cancelNewCustomer() {
      // Reset the new customer timer
      document.getElementById('new-customer-timer').textContent = '00:00:00';
      
      // Close the modal and reset fields
      closeModal('newCustomerModal');
      document.getElementById('new-customer-name').value = '';
      document.getElementById('new-customer-hours').value = '';
      document.getElementById('new-customer-comment').value = '';
      
      // Clear the timer data
      newCustomerTimer = null;
    }
    
    // Initialize the app
    window.onload = loadCustomers;
  </script>
</body>
</html>