<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enkel Timetracker</title>
  <style>
    :root {
      --bg-dark: #121212;
      --bg-card: #1e1e1e;
      --bg-modal: #242424;
      --text-primary: #ffffff;
      --text-secondary: #b0b0b0;
      --accent-primary: #9d4edd;
      --accent-secondary: #7b2cbf;
      --accent-gradient: linear-gradient(135deg, #9d4edd, #7b2cbf);
      --inactive: #4f4f4f;
      --active: #9d4edd;
      --border-inactive: #383838;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      --transition: all 0.3s ease;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--bg-dark);
      color: var(--text-primary);
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 2.5rem;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }
    
    .current-date {
      font-size: 16px;
      font-weight: 500;
      color: var(--accent-primary);
      margin-top: 5px;
      margin-bottom: 10px;
    }
    
    .update-status {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 5px;
      margin-bottom: 15px;
    }
    
    .refresh-btn {
      background: var(--accent-gradient);
      color: white;
      border: none;
      padding: 8px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: var(--transition);
      margin-top: 5px;
    }

    .refresh-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(157, 78, 221, 0.4);
    }
    
    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: flex-start;
    }
    
    .customer-box {
      width: 250px;
      height: 150px;
      background-color: var(--bg-card);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 15px;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid var(--border-inactive);
    }
    
    .customer-box:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(157, 78, 221, 0.2);
      border-color: var(--accent-primary);
    }
    
    .customer-box.active {
      box-shadow: 0 8px 25px rgba(157, 78, 221, 0.4);
      border: 1px solid var(--accent-primary);
      background: linear-gradient(to bottom, var(--bg-card), rgba(123, 44, 191, 0.1));
    }
    
    .customer-actions {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 10px;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 10;
    }
    
    .customer-box:hover .customer-actions {
      opacity: 1;
    }
    
    .customer-action-btn {
      background: rgba(157, 78, 221, 0.2);
      border: none;
      color: white;
      cursor: pointer;
      font-size: 16px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      transition: var(--transition);
    }
    
    .customer-action-btn:hover {
      background: rgba(157, 78, 221, 0.5);
      transform: scale(1.1);
    }
    
    .customer-name {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
      color: var(--text-primary);
    }
    
    .available-hours {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }
    
    .timer {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
      color: var(--accent-primary);
    }
    
    .status {
      position: absolute;
      bottom: 15px;
      left: 15px;
      font-size: 14px;
      color: var(--inactive);
    }
    
    .active .status {
      color: var(--active);
      font-weight: bold;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
    }
    
    .modal-content {
      background-color: var(--bg-modal);
      margin: 15% auto;
      padding: 25px;
      border-radius: 15px;
      width: 50%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
      border: 1px solid var(--accent-secondary);
    }
    
    .close {
      color: var(--text-secondary);
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .close:hover {
      color: var(--accent-primary);
    }
    
    textarea {
      width: 100%;
      height: 100px;
      padding: 12px;
      margin: 10px 0;
      border-radius: 8px;
      background-color: var(--bg-dark);
      border: 1px solid var(--border-inactive);
      resize: none;
      color: var(--text-primary);
      font-family: inherit;
      transition: var(--transition);
    }
    
    textarea:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 8px rgba(157, 78, 221, 0.3);
    }
    
    .submit-btn {
      background: var(--accent-gradient);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: var(--transition);
    }
    
    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(157, 78, 221, 0.4);
    }
    
    .add-customer {
      width: 250px;
      height: 150px;
      background: linear-gradient(to bottom, var(--bg-card), rgba(123, 44, 191, 0.05));
      border: 1px dashed var(--border-inactive);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      order: -1; /* Makes this appear first */
      transition: var(--transition);
    }
    
    .add-customer:hover {
      border-color: var(--accent-primary);
      box-shadow: 0 5px 15px rgba(157, 78, 221, 0.2);
      transform: translateY(-5px);
    }
    
    .add-customer.active {
      border: 1px solid var(--accent-primary);
      background: linear-gradient(to bottom, var(--bg-card), rgba(123, 44, 191, 0.2));
    }
    
    .add-customer-icon {
      font-size: 40px;
      color: var(--inactive);
      transition: var(--transition);
    }
    
    .add-customer:hover .add-customer-icon {
      color: var(--accent-primary);
    }
    
    .add-customer.active .add-customer-icon {
      color: var(--accent-primary);
    }
    
    .add-customer-timer {
      font-size: 24px;
      font-weight: bold;
      margin-top: 10px;
      color: var(--accent-primary);
    }
    
    .new-customer-modal .modal-content {
      width: 40%;
      max-height: 80vh;
      overflow-y: auto;
      margin: 10% auto;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: var(--text-primary);
    }
    
    .form-group input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      background-color: var(--bg-dark);
      border: 1px solid var(--border-inactive);
      color: var(--text-primary);
      font-family: inherit;
      transition: var(--transition);
    }
    
    .form-group input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 8px rgba(157, 78, 221, 0.3);
    }
    
    /* Styling for modal titles */
    .modal-content h2 {
      color: var(--text-primary);
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 1.6rem;
      border-bottom: 1px solid var(--border-inactive);
      padding-bottom: 10px;
    }
    
    /* Styling for customer info in modal */
    #modal-customer-name, #new-customer-time-spent {
      color: var(--accent-primary);
      font-weight: 500;
      font-size: 1.1rem;
    }
    
    #modal-time-spent {
      color: var(--text-secondary);
    }
    
    /* Modal for editing customer */
    #editCustomerModal .modal-content {
      width: 40%;
      max-height: 80vh;
      overflow-y: auto;
      margin: 10% auto;
    }
    
    /* Confirmation modal */
    #confirmDeleteModal .modal-content {
      width: 30%;
      text-align: center;
    }
    
    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    
    .cancel-btn {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border-inactive);
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: var(--transition);
    }
    
    .cancel-btn:hover {
      background: var(--bg-modal);
      border-color: var(--text-secondary);
    }
    
    .delete-btn {
      background: #e53935;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: var(--transition);
    }
    
    .delete-btn:hover {
      background: #c62828;
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Cornys Timetracker</h1>
    <div id="current-date" class="current-date"></div>
    <div class="update-status">Sist oppdatert: <span id="last-updated">Aldri</span></div>
    <button id="refresh-button" class="refresh-btn" onclick="fetchCustomerData()">
      Oppdater data
    </button>
  </div>
  
  <div class="container" id="customer-container">
    <!-- Add customer button always comes first -->
    <div class="add-customer" id="add-customer-box" onclick="startNewCustomerTimer()">
      <div class="add-customer-icon">+</div>
      <div class="add-customer-timer" id="new-customer-timer">00:00:00</div>
    </div>
    
    <!-- Customer boxes will be added here, sorted alphabetically -->
  </div>
  
  <!-- Modal for comments -->
  <div id="commentModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('commentModal')">&times;</span>
      <h2>Legg til kommentar</h2>
      <p id="modal-customer-name">Kunde AS</p>
      <p id="modal-time-spent">Tid brukt: 00:00:00</p>
      <textarea id="comment-text" placeholder="Skriv en kommentar om arbeidet..."></textarea>
      <button class="submit-btn" onclick="submitTime()">Lagre og avslutt</button>
    </div>
  </div>
  
  <!-- Modal for new customer -->
  <div id="newCustomerModal" class="modal new-customer-modal">
    <div class="modal-content">
      <span class="close" onclick="cancelNewCustomer()">&times;</span>
      <h2>Legg til ny kunde</h2>
      <p id="new-customer-time-spent">Tid brukt: 00:00:00</p>
      
      <div class="form-group">
        <label for="new-customer-name">Kundenavn:</label>
        <input type="text" id="new-customer-name" placeholder="Skriv inn kundenavn">
      </div>
      
      <div class="form-group">
        <label for="new-customer-hours">Timer tilgjengelig:</label>
        <input type="number" id="new-customer-hours" placeholder="Antall timer">
      </div>
      
      <div class="form-group">
        <label for="new-customer-comment">Kommentar:</label>
        <textarea id="new-customer-comment" placeholder="Skriv en kommentar om arbeidet..."></textarea>
      </div>
      
      <button class="submit-btn" onclick="createNewCustomer()">Lagre kunde og tid</button>
    </div>
  </div>
  
  <!-- Modal for editing customer -->
  <div id="editCustomerModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('editCustomerModal')">&times;</span>
      <h2>Rediger kunde</h2>
      
      <div class="form-group">
        <label for="edit-customer-name">Kundenavn:</label>
        <input type="text" id="edit-customer-name">
      </div>
      
      <div class="form-group">
        <label for="edit-customer-hours">Timer tilgjengelig:</label>
        <input type="number" id="edit-customer-hours">
      </div>
      
      <input type="hidden" id="edit-customer-id">
      <button class="submit-btn" onclick="updateCustomer()">Lagre endringer</button>
    </div>
  </div>
  
  <!-- Confirmation modal for delete -->
  <div id="confirmDeleteModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('confirmDeleteModal')">&times;</span>
      <h2>Bekreft sletting</h2>
      <p>Er du sikker p√• at du vil slette kunden <span id="delete-customer-name"></span>?</p>
      <p>Denne handlingen kan ikke angres.</p>
      
      <input type="hidden" id="delete-customer-id">
      <div class="modal-buttons">
        <button class="cancel-btn" onclick="closeModal('confirmDeleteModal')">Avbryt</button>
        <button class="delete-btn" onclick="deleteCustomer()">Slett kunde</button>
      </div>
    </div>
  </div>
  
  <script>
    // Google Script URL - Erstatt denne med din egen URL fra Google Apps Script
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxuA6snPxVx5pTrbE1SaONIc6jAnroH5FpAEvDsUADxYNg1veipInqRWbEMkenNWPPe/exec';
    
    // Store active timers and their data
    const timers = {};
    let activeBox = null;
    let customers = [];
    let newCustomerTimer = null;
    
    // Load customer data from Google Sheets
    function loadCustomers() {
      fetchCustomerData();
    }
    
    // Funksjon for √• regelmessig oppdatere kundedata
    function startAutoRefresh() {
      // Oppdater kundedata hvert 30. sekund
      setInterval(() => {
        fetchCustomerData();
      }, 30000); // 30000 ms = 30 sekunder
    }

    // Separate function to fetch customer data
    function fetchCustomerData() {
      fetch(`${GOOGLE_SCRIPT_URL}?action=getCustomers`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Sort customers alphabetically
            customers = data.customers.sort((a, b) => a.name.localeCompare(b.name));
            
            // Render the customer boxes
            renderCustomers();
            
            // Update last updated time
            const now = new Date();
            document.getElementById('last-updated').textContent = now.toLocaleTimeString();
          }
        })
        .catch(error => {
          console.error('Error fetching customer data:', error);
          
          // For offline testing, use mock data
          if (customers.length === 0) {
            console.log('Fallback to mock data for testing');
            const mockCustomerData = [
              { name: "Kunde 1 AS", availableHours: 40 },
              { name: "Kunde 3 AS", availableHours: 25 },
              { name: "Kunde 2 AS", availableHours: 60 },
              { name: "Kunde 4 AS", availableHours: 15 }
            ];
            
            // Sort customers alphabetically
            customers = mockCustomerData.sort((a, b) => a.name.localeCompare(b.name));
            
            // Render the customer boxes
            renderCustomers();
            
            alert('Kunne ikke koble til Google Sheets. Bruker testdata.');
          }
        });
    }
    
    function renderCustomers() {
      const container = document.getElementById('customer-container');
      
      // Clear existing customer boxes, but keep the "add customer" button
      const addCustomerButton = document.querySelector('.add-customer');
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }
      container.appendChild(addCustomerButton);
      
      // Add all customers in alphabetical order
      customers.forEach((customer, index) => {
        const customerBox = document.createElement('div');
        customerBox.className = 'customer-box';
        customerBox.setAttribute('data-id', index + 1);
        
        // Create customer content
        const nameDiv = document.createElement('div');
        nameDiv.className = 'customer-name';
        nameDiv.textContent = customer.name;
        
        const hoursDiv = document.createElement('div');
        hoursDiv.className = 'available-hours';
        hoursDiv.textContent = `Timer tilgjengelig: ${customer.availableHours.toFixed(1)}`;
        
        const timerDiv = document.createElement('div');
        timerDiv.className = 'timer';
        timerDiv.textContent = '00:00:00';
        
        const statusDiv = document.createElement('div');
        statusDiv.className = 'status';
        statusDiv.textContent = 'Inaktiv';
        
        // Create action buttons container
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'customer-actions';
        actionsDiv.style.opacity = '1';  // Force visibility
        actionsDiv.style.position = 'absolute';
        actionsDiv.style.top = '10px';
        actionsDiv.style.right = '10px';
        actionsDiv.style.display = 'flex';
        actionsDiv.style.gap = '10px';
        actionsDiv.style.zIndex = '100';
        
        // Create edit button
        const editBtn = document.createElement('button');
        editBtn.className = 'customer-action-btn';
        editBtn.title = 'Rediger kunde';
        editBtn.innerHTML = '‚úèÔ∏è';
        editBtn.onclick = function(e) {
          e.stopPropagation();
          showEditCustomer(index);
        };
        
        // Create delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'customer-action-btn';
        deleteBtn.title = 'Slett kunde';
        deleteBtn.innerHTML = 'üóëÔ∏è';
        deleteBtn.onclick = function(e) {
          e.stopPropagation();
          confirmDeleteCustomer(index);
        };
        
        // Append buttons to actions div
        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);
        
        // Append all elements to customer box
        customerBox.appendChild(nameDiv);
        customerBox.appendChild(hoursDiv);
        customerBox.appendChild(timerDiv);
        customerBox.appendChild(statusDiv);
        customerBox.appendChild(actionsDiv);
        
        // Add click handler for timer
        customerBox.onclick = function(e) {
          if (e.target === editBtn || e.target === deleteBtn || e.target === actionsDiv) {
            return; // Don't toggle timer if clicking on buttons
          }
          toggleTimer(this);
        };
        
        container.appendChild(customerBox);
      });
    }
    
    function toggleTimer(box) {
      const customerId = box.getAttribute('data-id');
      const timerDisplay = box.querySelector('.timer');
      const statusDisplay = box.querySelector('.status');
      const customerName = box.querySelector('.customer-name').textContent;
      
      // If this box is already active, stop the timer and show comment modal
      if (box.classList.contains('active')) {
        clearInterval(timers[customerId].interval);
        box.classList.remove('active');
        statusDisplay.textContent = 'Inaktiv';
        
        // Calculate time spent
        const endTime = new Date();
        const timeSpent = endTime - timers[customerId].startTime;
        const timeSpentFormatted = formatTime(timeSpent);
        
        // Show comment modal
        const modal = document.getElementById('commentModal');
        document.getElementById('modal-customer-name').textContent = customerName;
        document.getElementById('modal-time-spent').textContent = 'Tid brukt: ' + timeSpentFormatted;
        modal.style.display = 'block';
        
        // Save data for submission
        timers[customerId].endTime = endTime;
        timers[customerId].timeSpentFormatted = timeSpentFormatted;
        timers[customerId].timeSpentMs = timeSpent;
        activeBox = box;
      } else {
        // If another box is active (including new customer), deactivate it first
        if (activeBox) {
          toggleTimer(activeBox);
        } else if (document.getElementById('add-customer-box').classList.contains('active')) {
          stopNewCustomerTimer();
        }
        
        // Start a new timer
        box.classList.add('active');
        statusDisplay.textContent = 'Aktiv';
        
        const startTime = new Date();
        timers[customerId] = {
          startTime: startTime,
          customerName: customerName,
          interval: setInterval(() => {
            const currentTime = new Date();
            const elapsedTime = currentTime - startTime;
            timerDisplay.textContent = formatTime(elapsedTime);
          }, 1000)
        };
        
        activeBox = box;
      }
    }
    
    function startNewCustomerTimer() {
      // If there's an active timer for an existing customer, stop it
      if (activeBox) {
        toggleTimer(activeBox);
        return;
      }
      
      // If the new customer timer is already active, stop it
      const addCustomerBox = document.getElementById('add-customer-box');
      if (addCustomerBox.classList.contains('active')) {
        stopNewCustomerTimer();
        return;
      }
      
      // Start the new customer timer
      addCustomerBox.classList.add('active');
      const timerDisplay = document.getElementById('new-customer-timer');
      
      const startTime = new Date();
      newCustomerTimer = {
        startTime: startTime,
        interval: setInterval(() => {
          const currentTime = new Date();
          const elapsedTime = currentTime - startTime;
          timerDisplay.textContent = formatTime(elapsedTime);
        }, 1000)
      };
    }
    
    function stopNewCustomerTimer() {
      if (!newCustomerTimer) return;
      
      clearInterval(newCustomerTimer.interval);
      const addCustomerBox = document.getElementById('add-customer-box');
      addCustomerBox.classList.remove('active');
      
      // Calculate time spent
      const endTime = new Date();
      const timeSpent = endTime - newCustomerTimer.startTime;
      const timeSpentFormatted = formatTime(timeSpent);
      
      // Show the new customer modal
      const modal = document.getElementById('newCustomerModal');
      document.getElementById('new-customer-time-spent').textContent = 'Tid brukt: ' + timeSpentFormatted;
      modal.style.display = 'block';
      
      // Save time data for later use
      newCustomerTimer.endTime = endTime;
      newCustomerTimer.timeSpentFormatted = timeSpentFormatted;
      newCustomerTimer.timeSpentMs = timeSpent;
    }
    
    function formatTime(ms) {
      let seconds = Math.floor(ms / 1000);
      let minutes = Math.floor(seconds / 60);
      let hours = Math.floor(minutes / 60);
      
      seconds = seconds % 60;
      minutes = minutes % 60;
      
      return `${padZero(hours)}:${padZero(minutes)}:${padZero(seconds)}`;
    }
    
    function padZero(num) {
      return num.toString().padStart(2, '0');
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
      if (modalId === 'commentModal') {
        document.getElementById('comment-text').value = '';
      }
    }
    
    function calculateHoursFromMs(ms) {
      // Convert milliseconds to decimal hours
      const rawHours = ms / (1000 * 60 * 60);
      
      // For logging in Google Sheets, round to quarter hours (0.25)
      // e.g., 15 min = 0.25, 30 min = 0.5, 45 min = 0.75
      return Math.round(rawHours * 4) / 4;
    }
    
    function submitTime() {
      const customerId = activeBox.getAttribute('data-id');
      const comment = document.getElementById('comment-text').value;
      
      // Get current date
      const now = new Date();
      const dateStr = `${now.getFullYear()}-${padZero(now.getMonth() + 1)}-${padZero(now.getDate())}`;
      
      // Calculate decimal hours (rounded to quarter hours)
      const decimalHours = calculateHoursFromMs(timers[customerId].timeSpentMs);
      
      // Get customer's total sold hours and remaining hours
      let soldHours = 0;
      let remainingHours = 0;
      
      const customerIndex = parseInt(customerId) - 1;
      if (customerIndex >= 0 && customerIndex < customers.length) {
        // Calculate total and remaining hours
        soldHours = customers[customerIndex].availableHours + decimalHours; // Original hours before this session
        remainingHours = customers[customerIndex].availableHours - decimalHours; // Remaining after this session
        
        // Update local data
        customers[customerIndex].availableHours = remainingHours;
        if (customers[customerIndex].availableHours < 0) {
          customers[customerIndex].availableHours = 0;
          remainingHours = 0;
        }
      }
      
      // Prepare the data to be sent to Google Sheets
      const data = {
        action: "logTime",
        customerName: timers[customerId].customerName,
        timeSpent: decimalHours,
        soldHours: soldHours,
        remainingHours: remainingHours,
        comment: comment,
        date: dateStr
      };
      
      // Send data to Google Sheets
      fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(data)
      })
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            // Reset the timer display
            activeBox.querySelector('.timer').textContent = '00:00:00';
            
            // Close the modal
            closeModal('commentModal');
            
            // Clear the active box reference
            activeBox = null;
            
            // Re-render the customers to show updated available hours
            renderCustomers();
            
            // Show confirmation
            alert('Timer lagret for ' + data.customerName + '!');
          } else {
            alert('Kunne ikke lagre tid: ' + (result.message ||
